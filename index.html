<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PiggyVault â€” Il salvadanaio che non si rompe</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
  <style>
    *{-webkit-tap-highlight-color:transparent}
    body{-webkit-font-smoothing:antialiased}
    .screen{display:none}.screen.active{display:flex;flex-direction:column}
    .modal-overlay{display:none}.modal-overlay.active{display:flex}
    .pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid #475569;transition:all .15s}
    .pin-dot.filled{background:#3b82f6;border-color:#3b82f6}
    .pin-key:active{transform:scale(.92);background:#334155}
    input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1)}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#334155;border-radius:2px}
    .vault-card{transition:all .2s ease}
    .vault-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.3)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn .3s ease forwards}
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen overflow-x-hidden">

<!-- WELCOME -->
<div id="screen-welcome" class="screen min-h-screen items-center justify-center p-6">
  <div class="w-full max-w-sm mx-auto text-center">
    <div class="fade-in mb-12">
      <div class="text-8xl mb-5">ï¿½</div>
      <h1 class="text-4xl font-bold mb-2">PiggyVault</h1>
      <p class="text-slate-400 mb-3 text-lg">Il salvadanaio che nemmeno tu puoi rompere.</p>
      <p class="text-slate-500 text-sm max-w-xs mx-auto leading-relaxed">Metti da parte i tuoi soldi e bloccali fino alla data che scegli. Nessuno puÃ² toccarli prima â€” nemmeno tu.</p>
    </div>
    <div class="space-y-3">
      <button onclick="App.startCreateWallet()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl text-base font-semibold shadow-lg shadow-blue-900/30 transition-colors">âœ¨ Inizia â€” Ã¨ gratis</button>
      <button onclick="App.showRestoreWallet()" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 py-4 rounded-2xl text-base font-semibold transition-colors">ğŸ”‘ Ho giÃ  un account</button>
    </div>
    <div class="flex justify-center gap-6 mt-8 text-xs text-slate-500">
      <span>ğŸ”’ Privato</span>
      <span>ğŸ†“ Gratuito</span>
      <span>ğŸ“± Funziona offline</span>
    </div>
  </div>
</div>

<!-- SHOW SEED -->
<div id="screen-seed-create" class="screen min-h-screen p-6">
  <div class="w-full max-w-md mx-auto">
    <button onclick="App.goBack()" class="text-slate-400 hover:text-white mb-6 flex items-center gap-1 text-sm">â† Indietro</button>
    <h2 class="text-2xl font-bold mb-1">ğŸ”‘ Le tue 12 parole segrete</h2>
    <p class="text-slate-400 text-sm mb-4">Queste parole sono la <strong class="text-white">combinazione della tua cassaforte</strong>. Sono l'unico modo per recuperare i tuoi risparmi se cambi telefono.</p>
    <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 mb-6">
      <p class="text-amber-400 text-sm font-semibold">ğŸ“ Scrivile su carta adesso</p>
      <p class="text-amber-300/80 text-xs mt-1 leading-relaxed">Copiala su un foglio e mettilo al sicuro. Se perdi queste parole, <strong>nessuno</strong> potrÃ  aiutarti a recuperare i soldi â€” nemmeno noi.</p>
    </div>
    <div id="seed-words-grid" class="grid grid-cols-3 gap-2.5 mb-4"></div>
    <button onclick="App.copySeedCreate()" class="w-full bg-slate-700 hover:bg-slate-600 border border-slate-600 py-3 rounded-xl text-sm font-medium transition-colors mb-4" id="copy-seed-create-btn">ğŸ“‹ Copia le parole</button>
    <div class="flex gap-3">
      <button onclick="App.goBack()" class="flex-1 bg-slate-800 border border-slate-700 py-4 rounded-xl font-medium text-sm transition-colors">Annulla</button>
      <button onclick="App.confirmSeedWritten()" class="flex-[2] bg-blue-600 hover:bg-blue-500 py-4 px-4 rounded-xl font-semibold text-sm transition-colors">âœ… Fatto, le ho salvate</button>
    </div>
  </div>
</div>

<!-- SET PIN -->
<div id="screen-set-pin" class="screen min-h-screen items-center justify-center p-6">
  <div class="w-full max-w-xs mx-auto text-center">
    <div class="text-5xl mb-4">ğŸ”‘</div>
    <h2 class="text-2xl font-bold mb-1" id="set-pin-title">Crea il tuo PIN</h2>
    <p class="text-slate-400 text-sm mb-8" id="set-pin-desc">Scegli 6 numeri per aprire la tua app velocemente.</p>
    <div class="flex justify-center gap-3 mb-8" id="pin-dots-set">
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div id="pin-error-set" class="hidden text-red-400 text-sm mb-4 bg-red-500/10 py-2 px-4 rounded-xl"></div>
    <div class="grid grid-cols-3 gap-3 max-w-[220px] mx-auto">
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('1','set')">1</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('2','set')">2</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('3','set')">3</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('4','set')">4</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('5','set')">5</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('6','set')">6</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('7','set')">7</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('8','set')">8</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('9','set')">9</button>
      <div></div>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('0','set')">0</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinBackspace('set')">âŒ«</button>
    </div>
  </div>
</div>

<!-- UNLOCK -->
<div id="screen-unlock" class="screen min-h-screen items-center justify-center p-6">
  <div class="w-full max-w-xs mx-auto text-center">
    <div class="text-5xl mb-3">ğŸ”</div>
    <h2 class="text-2xl font-bold mb-1">Bentornato! ğŸ‘‹</h2>
    <p class="text-slate-500 text-xs mb-1" id="unlock-address-short"></p>
    <p class="text-slate-400 text-sm mb-8">Inserisci il tuo PIN per entrare</p>
    <div class="flex justify-center gap-3 mb-8" id="pin-dots-unlock">
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div id="pin-error-unlock" class="hidden text-red-400 text-sm mb-4 bg-red-500/10 py-2 px-4 rounded-xl"></div>
    <div class="grid grid-cols-3 gap-3 max-w-[220px] mx-auto">
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('1','unlock')">1</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('2','unlock')">2</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('3','unlock')">3</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('4','unlock')">4</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('5','unlock')">5</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('6','unlock')">6</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('7','unlock')">7</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('8','unlock')">8</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('9','unlock')">9</button>
      <div></div>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinKeyPress('0','unlock')">0</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-14 text-xl font-semibold" onclick="App.pinBackspace('unlock')">âŒ«</button>
    </div>
    <button onclick="App.forgotPin()" class="text-slate-500 hover:text-slate-300 text-sm mt-6 block mx-auto transition-colors">PIN dimenticato? Recupera con le 12 parole â†’</button>
  </div>
</div>

<!-- RESTORE -->
<div id="screen-seed-restore" class="screen min-h-screen p-6">
  <div class="w-full max-w-md mx-auto">
    <button onclick="App.goBack()" class="text-slate-400 hover:text-white mb-6 flex items-center gap-1 text-sm">â† Indietro</button>
    <h2 class="text-2xl font-bold mb-1" id="restore-title">Recupera il tuo account</h2>
    <p class="text-slate-400 text-sm mb-6" id="restore-desc">Inserisci le 12 parole segrete che avevi salvato, nell'ordine corretto.</p>
    <div id="restore-words-grid" class="grid grid-cols-3 gap-2 mb-5"></div>
    <div id="restore-error" class="hidden bg-red-500/10 border border-red-500/30 text-red-400 text-sm p-3 rounded-xl mb-4"></div>
    <button onclick="App.restoreWallet()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-semibold transition-colors">ğŸ”“ Recupera i miei risparmi</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="screen-dashboard" class="screen min-h-screen flex-col">
  <header class="bg-slate-800/80 backdrop-blur-md sticky top-0 z-10 px-4 py-3 border-b border-slate-700/50">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2.5">
        <span class="text-2xl">ï¿½</span>
        <div><span class="font-bold text-base block leading-tight">PiggyVault</span><span class="text-xs text-slate-500">I tuoi risparmi al sicuro</span></div>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="App.openOnramp()" class="bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 text-blue-400 text-xs px-3 py-1.5 rounded-full font-medium transition-colors">ğŸ’³ Aggiungi soldi</button>
        <button onclick="App.showSettings()" class="text-slate-400 hover:text-white text-xl">âš™ï¸</button>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6 w-full flex-1">
    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
      <div class="bg-slate-800 rounded-2xl p-5 border border-slate-700 col-span-2 md:col-span-1">
        <p class="text-slate-400 text-xs font-medium uppercase tracking-wider mb-2">Totale Bloccato</p>
        <div class="flex items-baseline gap-2">
          <p class="text-3xl font-bold" id="stat-total">0.00</p>
          <span class="text-slate-400 text-sm" id="stat-currency">$</span>
        </div>
      </div>
      <div class="bg-slate-800 rounded-2xl p-5 border border-slate-700">
        <p class="text-slate-400 text-xs font-medium uppercase tracking-wider mb-2">Salvadanai</p>
        <p class="text-3xl font-bold" id="stat-vaults">0</p>
        <p class="text-slate-400 text-xs mt-1">obiettivi attivi</p>
      </div>
      <div class="bg-slate-800 rounded-2xl p-5 border border-slate-700">
        <p class="text-slate-400 text-xs font-medium uppercase tracking-wider mb-2">Prossimo Sblocco</p>
        <p class="text-base font-bold leading-tight" id="stat-next-unlock">â€”</p>
        <p class="text-slate-400 text-xs mt-1" id="stat-days-left">nessun salvadanaio</p>
      </div>
    </div>

    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">I Tuoi Salvadanai</h2>
      <button onclick="App.showNewVaultModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-colors">+ Nuovo</button>
    </div>

    <div id="vaults-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
      <div id="empty-vaults" class="col-span-full border-2 border-dashed border-slate-700/60 rounded-2xl p-12 text-center text-slate-500">
        <div class="text-5xl mb-3">ğŸ¯</div>
        <p class="font-medium">Nessun salvadanaio ancora</p>
        <p class="text-sm mt-1">Crea il primo e inizia a mettere da parte!</p>
      </div>
    </div>

    <div id="chart-section" class="hidden bg-slate-800 rounded-2xl p-6 border border-slate-700 mb-8">
      <h3 class="font-semibold mb-1">I Tuoi Progressi</h3>
      <p class="text-slate-400 text-xs mb-4">Come stanno crescendo i tuoi risparmi</p>
      <canvas id="main-chart" height="100"></canvas>
    </div>

    <div class="bg-slate-800/50 rounded-2xl p-6 border border-slate-700/50 text-center">
      <p class="text-slate-400 text-sm mb-3">PiggyVault Ã¨ gratis e open source.<br>Se ti piace, offrici un caffÃ¨ â˜•</p>
      <button onclick="App.copyDonationAddress()" class="inline-flex items-center gap-2 bg-slate-700 hover:bg-slate-600 border border-slate-600 px-5 py-2.5 rounded-full text-sm font-medium transition-colors">â˜• Dona</button>
      <p id="donation-copied" class="hidden text-green-400 text-xs mt-2">âœ… Indirizzo copiato!</p>
    </div>
  </main>
</div>

<!-- MODAL: NEW VAULT -->
<div id="modal-new-vault" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm z-50 items-end md:items-center justify-center p-4" onclick="App.closeModal('modal-new-vault')">
  <div class="bg-slate-800 rounded-3xl w-full max-w-md border border-slate-600 overflow-hidden" onclick="event.stopPropagation()">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-xl font-bold">ğŸ· Nuovo Salvadanaio</h3>
        <button onclick="App.closeModal('modal-new-vault')" class="text-slate-400 hover:text-white text-2xl leading-none">Ã—</button>
      </div>
      <p class="text-slate-400 text-xs uppercase tracking-wider mb-3">Per cosa stai risparmiando?</p>
      <div id="icon-picker" class="grid grid-cols-5 gap-2 mb-5"></div>
      <div class="mb-4">
        <label class="text-slate-400 text-xs uppercase tracking-wider mb-2 block">Dai un nome</label>
        <input id="vault-name" type="text" maxlength="30" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="es. Vacanze a Ibiza">
      </div>
      <div class="mb-4">
        <label class="text-slate-400 text-xs uppercase tracking-wider mb-2 block">Quando puoi riaprirlo?</label>
        <div class="grid grid-cols-2 gap-2">
          <button type="button" onclick="App.setUnlockMode(0)" id="mode-btn-0" class="unlock-mode-btn py-2.5 rounded-xl text-xs font-semibold border-2 border-blue-500 bg-blue-500/15 text-blue-400 transition-all">ğŸ“… A una data</button>
          <button type="button" onclick="App.setUnlockMode(1)" id="mode-btn-1" class="unlock-mode-btn py-2.5 rounded-xl text-xs font-semibold border-2 border-slate-700 text-slate-400 transition-all">ğŸ’° A una cifra</button>
          <button type="button" onclick="App.setUnlockMode(2)" id="mode-btn-2" class="unlock-mode-btn py-2.5 rounded-xl text-xs font-semibold border-2 border-slate-700 text-slate-400 transition-all">ğŸ“… o ğŸ’° Il primo dei due</button>
          <button type="button" onclick="App.setUnlockMode(3)" id="mode-btn-3" class="unlock-mode-btn py-2.5 rounded-xl text-xs font-semibold border-2 border-slate-700 text-slate-400 transition-all">ğŸ“… + ğŸ’° Tutti e due</button>
        </div>
        <p id="mode-hint" class="text-slate-500 text-xs mt-2">Si apre quando arriva la data che scegli.</p>
      </div>
      <div class="mb-4">
        <label class="text-slate-400 text-xs uppercase tracking-wider mb-2 block">Valuta</label>
        <select id="vault-currency" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
          <option value="USDC">USDC (dollaro digitale)</option>
          <option value="EURC">EURC (euro digitale)</option>
          <option value="DAI">DAI (dollaro digitale)</option>
          <option value="USDT">USDT (dollaro digitale)</option>
        </select>
        <p class="text-slate-500 text-xs mt-1.5">Sono valute stabili: 1 USDC = 1$, 1 EURC = 1â‚¬. Il valore non oscilla.</p>
      </div>
      <div id="vault-target-row" class="mb-4 hidden">
        <label class="text-slate-400 text-xs uppercase tracking-wider mb-2 block">Quanto vuoi raggiungere?</label>
        <input id="vault-target" type="number" min="1" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="es. 10000">
      </div>
      <div id="vault-date-row" class="mb-5">
        <label class="text-slate-400 text-xs uppercase tracking-wider mb-2 block">Non aprire prima del</label>
        <input id="vault-date" type="date" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
      </div>
      <div id="vault-error" class="hidden bg-red-500/10 border border-red-500/30 text-red-400 text-sm p-3 rounded-xl mb-4"></div>
      <button onclick="App.createVault()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-semibold transition-colors">ï¿½ Crea il mio salvadanaio</button>
    </div>
  </div>
</div>

<!-- MODAL: VAULT DETAIL -->
<div id="modal-vault-detail" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm z-50 items-end md:items-center justify-center p-4" onclick="App.closeModal('modal-vault-detail')">
  <div class="bg-slate-800 rounded-3xl w-full max-w-md border border-slate-600 max-h-[92vh] overflow-y-auto" onclick="event.stopPropagation()">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-xl font-bold" id="detail-title"></h3>
        <button onclick="App.closeModal('modal-vault-detail')" class="text-slate-400 hover:text-white text-2xl leading-none">Ã—</button>
      </div>

      <!-- Progress -->
      <div class="bg-slate-900 rounded-2xl p-4 mb-4">
        <div class="flex justify-between text-sm mb-2">
          <span class="text-slate-400">Messo da parte</span>
          <span class="font-semibold" id="detail-amount">0</span>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-3 mb-2">
          <div id="detail-progress-bar" class="h-3 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
        <div class="flex justify-between text-xs text-slate-400">
          <span id="detail-pct">0%</span>
          <span>Obiettivo: <span id="detail-target">0</span></span>
        </div>
      </div>

      <!-- Unlock status -->
      <div id="detail-unlock-box" class="bg-slate-900 rounded-2xl p-4 mb-4">
        <p class="text-slate-400 text-xs mb-2 uppercase tracking-wider">Quando si apre</p>
        <div id="detail-unlock-status" class="text-center mb-2">
          <p class="text-3xl font-bold" id="detail-countdown">â€”</p>
        </div>
        <div id="detail-conditions" class="space-y-2 text-sm"></div>
        <p class="text-slate-400 text-xs mt-2 text-center" id="detail-unlock-date"></p>
      </div>

      <!-- Chart -->
      <div class="bg-slate-900 rounded-2xl p-4 mb-4">
        <canvas id="vault-chart" height="90"></canvas>
      </div>

      <!-- Deposit section -->
      <div class="bg-slate-900 rounded-2xl p-4 mb-4">
        <p class="text-slate-400 text-xs uppercase tracking-wider mb-3">Aggiungi soldi</p>
        <div id="matic-warning" class="hidden bg-amber-500/10 border border-amber-500/30 text-amber-400 text-xs p-2 rounded-xl mb-2">
          â›½ Servono pochi centesimi per la commissione. <button onclick="App.autoGetMatic()" class="underline font-semibold">Risolvilo automaticamente</button>
        </div>
        <div id="deposit-error" class="hidden bg-red-500/10 border border-red-500/30 text-red-400 text-xs p-2 rounded-xl mb-2"></div>
        <div class="flex gap-2 mb-2">
          <input id="deposit-amount" type="number" min="0.01" step="0.01" placeholder="Quanto vuoi aggiungere?" class="flex-1 bg-slate-800 border border-slate-600 rounded-xl px-3 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 text-sm">
          <button onclick="App.showCaveauLock()" id="deposit-lock-btn" class="bg-blue-600 hover:bg-blue-500 px-4 py-2.5 rounded-xl text-sm font-semibold transition-colors whitespace-nowrap">ğŸ”’ Blocca</button>
        </div>

        <!-- Advanced deposit options (collapsed by default) -->
        <details class="mt-3">
          <summary class="text-slate-500 text-xs cursor-pointer hover:text-slate-300 transition-colors select-none">âš™ï¸ Opzioni avanzate</summary>
          <div class="mt-3 space-y-2 pt-2 border-t border-slate-700/50">
            <div>
              <label class="text-slate-500 text-xs mb-1 block">Deposita con un'altra valuta</label>
              <select id="deposit-src-token" onchange="App.onSrcTokenChange()" class="w-full bg-slate-800 border border-slate-600 rounded-xl px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                <option value="native">Stessa valuta del salvadanaio</option>
              </select>
              <p class="text-slate-600 text-xs mt-1">Converte automaticamente qualsiasi valuta.</p>
            </div>
            <div id="swap-quote-box" class="hidden bg-blue-500/10 border border-blue-500/30 rounded-xl p-2 text-xs text-blue-300">
              ğŸ’± Riceverai circa <span id="swap-dest-amount" class="font-bold">â€”</span> <span id="swap-dest-symbol"></span>
              <span class="text-blue-400/60 ml-1">(differenza max 1%)</span>
            </div>
            <div class="flex items-center gap-3">
              <button onclick="App.addDeposit()" class="text-slate-500 hover:text-slate-400 text-xs transition-colors">ğŸ“ Solo nota manuale</button>
              <span class="text-slate-700">Â·</span>
              <button onclick="App.openCrossChainModal()" class="text-purple-400 hover:text-purple-300 text-xs transition-colors font-medium">ğŸŒ Da Bitcoin / Ethereum</button>
            </div>
          </div>
        </details>
      </div>

      <!-- Transactions -->
      <div class="mb-4">
        <p class="text-slate-400 text-xs uppercase tracking-wider mb-3">Storico versamenti</p>
        <div id="detail-transactions" class="space-y-2"></div>
      </div>
      <div class="pt-4 border-t border-slate-700 text-center">
        <button onclick="App.panicButton()" class="text-red-500/40 hover:text-red-400 text-xs transition-colors">ğŸš« Voglio ritirare prima</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: PANIC -->
<div id="modal-panic" class="modal-overlay fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] items-center justify-center p-6" onclick="App.closeModal('modal-panic')">
  <div class="bg-slate-900 border-2 border-red-500/40 rounded-3xl p-8 max-w-sm text-center fade-in" onclick="event.stopPropagation()">
    <div class="text-6xl mb-4">ï¿½ğŸ”’</div>
    <h3 class="text-2xl font-bold text-red-400 mb-2">Non si puÃ² aprire!</h3>
    <p class="text-slate-300 mb-2">Questo Ã¨ esattamente il punto.</p>
    <p class="text-slate-400 text-sm mb-4 leading-relaxed">I tuoi soldi sono bloccati e <strong class="text-white">nessuno</strong> puÃ² toccarli prima della scadenza â€” nemmeno tu, nemmeno noi. Ãˆ cosÃ¬ che funziona il salvadanaio blindato.</p>
    <p class="text-white font-semibold mb-6" id="panic-date"></p>
    <button onclick="App.closeModal('modal-panic')" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-xl font-medium w-full transition-colors">Ho capito, torno indietro</button>
  </div>
</div>

<!-- MODAL: SETTINGS -->
<div id="modal-settings" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm z-50 items-end md:items-center justify-center p-4" onclick="App.closeModal('modal-settings')">
  <div class="bg-slate-800 rounded-3xl w-full max-w-md border border-slate-600" onclick="event.stopPropagation()">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">âš™ï¸ Impostazioni</h3>
        <button onclick="App.closeModal('modal-settings')" class="text-slate-400 hover:text-white text-2xl leading-none">Ã—</button>
      </div>
      <div class="space-y-3">
        <div class="bg-slate-900 rounded-xl p-4">
          <p class="text-slate-400 text-xs uppercase tracking-wider mb-1">Il tuo indirizzo</p>
          <p class="font-mono text-xs break-all" id="settings-address">â€”</p>
          <p class="text-slate-600 text-xs mt-1">Come un IBAN, ma per le crypto. Puoi condividerlo.</p>
        </div>
        <button onclick="App.showSeedPhrase()" class="w-full bg-amber-500/10 border border-amber-500/30 hover:bg-amber-500/20 text-amber-400 py-3 rounded-xl text-sm font-medium transition-colors">ğŸ”‘ Mostra le 12 parole segrete</button>
        <a id="polygonscan-link" href="#" target="_blank" class="block w-full bg-slate-700 hover:bg-slate-600 text-center text-white py-3 rounded-xl text-sm font-medium transition-colors">ğŸ” Vedi i miei movimenti</a>
        <details class="bg-slate-900 rounded-xl">
          <summary class="text-slate-400 text-xs px-4 py-3 cursor-pointer hover:text-slate-300">ğŸ”§ Per sviluppatori</summary>
          <div class="px-4 pb-3 space-y-2">
            <a href="https://github.com/creazionecontenuti-oss/caveau-digitale" target="_blank" class="block w-full bg-slate-700 hover:bg-slate-600 text-center text-white py-2.5 rounded-xl text-xs font-medium transition-colors">ğŸ“‚ Codice sorgente (GitHub)</a>
            <a href="https://QmVuCCjht978egtuzF2MVBbjPgTVYm2sBy3BMFDFn3b4up.ipfs.dweb.link/caveau-digitale/" target="_blank" class="block w-full bg-slate-700 hover:bg-slate-600 text-center text-white py-2.5 rounded-xl text-xs font-medium transition-colors">ğŸŒ Versione permanente (IPFS)</a>
          </div>
        </details>
        <button onclick="App.confirmDeleteWallet()" class="w-full bg-red-500/10 border border-red-500/30 hover:bg-red-500/20 text-red-400 py-3 rounded-xl text-sm font-medium transition-colors">ğŸ—‘ï¸ Esci e cancella da questo dispositivo</button>
      </div>
      <p class="text-slate-600 text-xs mt-4 text-center">PiggyVault v2.0 â€¢ I tuoi soldi, le tue regole</p>
    </div>
  </div>
</div>

<!-- MODAL: SHOW SEED -->
<div id="modal-show-seed" class="modal-overlay fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] items-center justify-center p-4" onclick="App.closeModal('modal-show-seed')">
  <div class="bg-slate-900 border border-amber-500/30 rounded-3xl w-full max-w-md p-6" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-amber-400">ğŸ”‘ Le tue parole segrete</h3>
      <button onclick="App.closeModal('modal-show-seed')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
    </div>
    <p class="text-slate-400 text-sm mb-4">Non mostrare queste parole a nessuno. Chi le ha puÃ² accedere ai tuoi soldi.</p>
    <div id="show-seed-grid" class="grid grid-cols-3 gap-2 mb-5"></div>
    <button onclick="App.copySeedPhrase()" class="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl text-sm font-medium transition-colors">ğŸ“‹ Copia le parole</button>
  </div>
</div>

<!-- MODAL: ON-RAMP -->
<div id="modal-onramp" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] items-end md:items-center justify-center p-4" onclick="App.closeModal('modal-onramp')">
  <div class="bg-slate-800 rounded-3xl w-full max-w-md border border-slate-600" onclick="event.stopPropagation()">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <div>
          <h3 class="text-xl font-bold">ğŸ’³ Aggiungi soldi</h3>
          <p class="text-slate-400 text-xs mt-0.5" id="onramp-subtitle">Quanto vuoi mettere nel tuo salvadanaio?</p>
        </div>
        <button onclick="App.closeModal('modal-onramp')" class="text-slate-400 hover:text-white text-2xl leading-none">Ã—</button>
      </div>

      <!-- STEP 1: scegli importo -->
      <div id="onramp-step1">
        <div class="grid grid-cols-4 gap-2 mb-3">
          <button onclick="App.setOnrampAmount(20)"  class="onramp-preset bg-slate-700 hover:bg-blue-600 border border-slate-600 hover:border-blue-500 py-3 rounded-xl text-sm font-bold transition-all">20â‚¬</button>
          <button onclick="App.setOnrampAmount(50)"  class="onramp-preset bg-slate-700 hover:bg-blue-600 border border-slate-600 hover:border-blue-500 py-3 rounded-xl text-sm font-bold transition-all">50â‚¬</button>
          <button onclick="App.setOnrampAmount(100)" class="onramp-preset bg-slate-700 hover:bg-blue-600 border border-slate-600 hover:border-blue-500 py-3 rounded-xl text-sm font-bold transition-all">100â‚¬</button>
          <button onclick="App.setOnrampAmount(200)" class="onramp-preset bg-slate-700 hover:bg-blue-600 border border-slate-600 hover:border-blue-500 py-3 rounded-xl text-sm font-bold transition-all">200â‚¬</button>
        </div>
        <div class="relative mb-5">
          <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">â‚¬</span>
          <input id="onramp-amount-input" type="number" min="10" placeholder="Altro importoâ€¦"
            class="w-full bg-slate-900 border border-slate-600 focus:border-blue-500 rounded-xl pl-8 pr-4 py-3 text-sm text-white focus:outline-none"
            oninput="App.setOnrampAmountCustom(this.value)">
        </div>
        <button onclick="App.onrampNext()" class="w-full bg-blue-600 hover:bg-blue-500 py-3.5 rounded-xl font-semibold text-sm transition-colors">Continua â†’</button>
      </div>

      <!-- STEP 2: QR + provider -->
      <div id="onramp-step2" class="hidden">
        <button onclick="App.onrampBack()" class="text-slate-400 hover:text-white text-xs mb-4 flex items-center gap-1">â† Cambia importo</button>
        <div class="flex gap-4 mb-4">
          <div class="shrink-0 bg-white p-1.5 rounded-xl">
            <img id="onramp-qr" src="" alt="QR" class="w-20 h-20 block rounded-lg">
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-slate-400 text-xs uppercase tracking-wider mb-1">Il tuo indirizzo</p>
            <p class="font-mono text-xs break-all text-white leading-relaxed" id="onramp-address">â€”</p>
            <button onclick="App.copyOnrampAddress()" class="mt-1.5 text-blue-400 hover:text-blue-300 text-xs transition-colors">ğŸ“‹ Copia</button>
            <span id="onramp-copied" class="hidden text-green-400 text-xs ml-2">âœ…</span>
          </div>
        </div>
        <p class="text-slate-500 text-xs mb-3">Scegli come vuoi pagare. L'importo arriverÃ  automaticamente nel tuo salvadanaio:</p>
        <div class="space-y-2">
          <button onclick="App.openMtPelerin()" class="w-full flex items-center justify-between bg-emerald-600/15 hover:bg-emerald-600/25 border border-emerald-500/40 px-4 py-3 rounded-xl transition-colors">
            <div class="text-left"><p class="font-semibold text-sm">ğŸ‡¨ğŸ‡­ Mt Pelerin <span class="text-emerald-400 text-xs font-normal ml-1">consigliato</span></p><p class="text-slate-400 text-xs">Bonifico SEPA Â· no KYC fino a 1000â‚¬ Â· svizzero</p></div>
            <span class="text-emerald-400 text-xs font-bold" id="onramp-label-mtpelerin"></span>
          </button>
          <button onclick="App.openGuardarian()" class="w-full flex items-center justify-between bg-blue-600/10 hover:bg-blue-600/20 border border-blue-500/30 px-4 py-3 rounded-xl transition-colors">
            <div class="text-left"><p class="font-semibold text-sm">Guardarian</p><p class="text-slate-400 text-xs">Bonifico SEPA Â· carta Â· ottimo per Italia</p></div>
            <span class="text-blue-400 text-xs font-bold" id="onramp-label-guardarian"></span>
          </button>
          <button onclick="App.openMoonpay()" class="w-full flex items-center justify-between bg-slate-700 hover:bg-slate-600 border border-slate-600 px-4 py-3 rounded-xl transition-colors">
            <div class="text-left"><p class="font-semibold text-sm">MoonPay</p><p class="text-slate-400 text-xs">Carta di credito/debito</p></div>
            <span class="text-slate-400 text-xs font-bold" id="onramp-label-moonpay"></span>
          </button>
          <button onclick="App.openTransak()" class="w-full flex items-center justify-between bg-slate-700 hover:bg-slate-600 border border-slate-600 px-4 py-3 rounded-xl transition-colors">
            <div class="text-left"><p class="font-semibold text-sm">Transak</p><p class="text-slate-400 text-xs">Apple Pay Â· Google Pay Â· carta</p></div>
            <span class="text-slate-400 text-xs font-bold" id="onramp-label-transak"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: PIN VERIFY -->
<div id="modal-pin-verify" class="modal-overlay fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] items-center justify-center p-6" onclick="App.closeModal('modal-pin-verify')">
  <div class="bg-slate-900 rounded-3xl w-full max-w-xs p-6 text-center" onclick="event.stopPropagation()">
    <div class="text-4xl mb-3">ğŸ”‘</div>
    <h3 class="text-lg font-bold mb-1">Conferma PIN</h3>
    <p class="text-slate-400 text-sm mb-6">Inserisci il PIN per continuare</p>
    <div class="flex justify-center gap-3 mb-4" id="pin-dots-verify">
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div id="pin-verify-error" class="hidden text-red-400 text-xs mb-3 bg-red-500/10 py-2 px-3 rounded-xl"></div>
    <div class="grid grid-cols-3 gap-2 max-w-[200px] mx-auto">
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('1')">1</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('2')">2</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('3')">3</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('4')">4</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('5')">5</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('6')">6</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('7')">7</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('8')">8</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('9')">9</button>
      <div></div>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyKeyPress('0')">0</button>
      <button class="pin-key bg-slate-800 rounded-2xl h-12 text-xl font-semibold" onclick="App.pinVerifyBackspace()">âŒ«</button>
    </div>
  </div>
</div>

<!-- MODAL: CROSS-CHAIN DEPOSIT -->
<div id="modal-crosschain" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] items-end md:items-center justify-center p-4" onclick="App.closeModal('modal-crosschain')">
  <div class="bg-slate-800 rounded-3xl w-full max-w-md border border-slate-600" onclick="event.stopPropagation()">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-xl font-bold">ğŸŒ Deposita da un'altra valuta</h3>
        <button onclick="App.closeCrossChain()" class="text-slate-400 hover:text-white text-2xl leading-none">Ã—</button>
      </div>
      <p class="text-slate-400 text-xs mb-4">Hai Bitcoin, Ethereum o altre crypto? Inviale qui e arriveranno automaticamente come <span id="cc-dest-currency" class="font-bold text-white">dollari digitali</span> nel tuo salvadanaio.</p>
      <div id="cc-step-select" class="">
        <label class="text-slate-500 text-xs mb-2 block uppercase tracking-wider">Scegli la crypto da inviare</label>
        <div id="cc-coin-grid" class="grid grid-cols-2 gap-2 mb-4"></div>
      </div>
      <div id="cc-step-address" class="hidden">
        <div class="bg-slate-900 rounded-2xl p-4 mb-3">
          <div class="flex justify-between text-sm mb-2"><span class="text-slate-400">Invii</span><span class="font-medium" id="cc-send-coin"></span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-400">Ricevi</span><span class="font-medium text-green-400" id="cc-receive-coin"></span></div>
        </div>
        <div class="bg-slate-900 rounded-2xl p-4 mb-3 text-center">
          <p class="text-slate-400 text-xs mb-2 uppercase tracking-wider">Manda a questo indirizzo</p>
          <p class="font-mono text-sm text-white break-all select-all bg-slate-800 p-3 rounded-xl" id="cc-deposit-address">â€”</p>
          <button onclick="App.copyCCAddress()" class="text-blue-400 hover:text-blue-300 text-xs mt-2 transition-colors">ğŸ“‹ Copia indirizzo</button>
        </div>
        <div id="cc-limits" class="text-xs text-slate-500 mb-3 text-center"></div>
        <div class="bg-slate-900 rounded-2xl p-4 mb-3">
          <p class="text-slate-400 text-xs mb-1">Stato</p>
          <p id="cc-status" class="text-sm font-medium text-yellow-400">â³ In attesa del deposito...</p>
        </div>
        <button onclick="App.closeCrossChain()" class="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl text-sm font-medium transition-colors">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: CAVEAU LOCK -->
<div id="modal-caveau-lock" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] items-end md:items-center justify-center p-4" onclick="App.closeModal('modal-caveau-lock')">
  <div class="bg-slate-800 rounded-3xl w-full max-w-md border border-slate-600" onclick="event.stopPropagation()">
    <div class="p-6">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-xl font-bold">ğŸ”’ Conferma il blocco</h3>
        <button onclick="App.closeModal('modal-caveau-lock')" class="text-slate-400 hover:text-white text-2xl leading-none">Ã—</button>
      </div>
      <div class="bg-slate-900 rounded-2xl p-4 mb-4 space-y-2.5">
        <div class="flex justify-between text-sm"><span class="text-slate-400">Salvadanaio</span><span class="font-medium" id="lock-vault-name"></span></div>
        <div class="flex justify-between text-sm"><span class="text-slate-400">Quanto blocchi</span><span class="font-bold text-blue-400" id="lock-amount"></span></div>
        <div class="flex justify-between text-sm" id="lock-date-row"><span class="text-slate-400">Si apre il</span><span class="font-medium" id="lock-date"></span></div>
        <div class="flex justify-between text-sm" id="lock-target-row"><span class="text-slate-400">Obiettivo</span><span class="font-medium" id="lock-target"></span></div>
        <div class="flex justify-between text-sm"><span class="text-slate-400">Tipo</span><span class="font-medium text-xs" id="lock-mode"></span></div>
        <div class="flex justify-between text-sm"><span class="text-slate-400">Account</span><span class="font-mono text-xs text-slate-300" id="lock-address"></span></div>
        <div class="flex justify-between text-sm border-t border-slate-700 pt-2">
          <span class="text-slate-400">Saldo disponibile</span>
          <span id="lock-balance" class="text-slate-400 text-sm">Caricamento...</span>
        </div>
      </div>
      <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3 mb-4">
        <p class="text-amber-400 text-xs font-semibold mb-1">âš ï¸ Non si puÃ² annullare</p>
        <p class="text-amber-300/70 text-xs">Una volta confermato, questi soldi saranno bloccati fino alla scadenza. Nessuno potrÃ  ritirarli prima â€” nemmeno tu.</p>
      </div>
      <div id="lock-status" class="text-sm min-h-[20px]"></div>
      <div class="space-y-2 mt-4">
        <button id="lock-execute-btn" onclick="App.executeCaveauLock()" class="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 py-4 rounded-xl font-semibold transition-colors">ğŸ”’ Blocca i soldi</button>
        <button onclick="App.closeModal('modal-caveau-lock')" class="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl text-sm font-medium transition-colors">Ci devo pensare</button>
      </div>
    </div>
  </div>
</div>

<script src="app.js"></script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' }).then(reg => {
      // Check immediately, then every 5 minutes
      reg.update();
      setInterval(() => reg.update(), 5 * 60 * 1000);
      // Detect waiting SW and force activate
      reg.addEventListener('updatefound', () => {
        const newSW = reg.installing;
        if (newSW) {
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'activated') {
              window.location.reload();
            }
          });
        }
      });
    }).catch(() => {});
    // Listen for SW update message (backup notification)
    navigator.serviceWorker.addEventListener('message', e => {
      if (e.data?.type === 'SW_UPDATED') {
        console.log('[PWA] Aggiornato a:', e.data.version);
      }
    });
  }
</script>
</body>
</html>
